
 AMMS (Account ManageMent for Squid)

 Система управления аккаунтами пользователей Squid. Обеспечивает
 подсчет трафика и блокировку пользователей. Работает как web сервис.

 Конфигурационный файл:

    Формат и возможности описаны в:
 http://search.cpan.org/~tlinden/Config-General-2.48/General.pm

 AMMSD

    Управление аккаунтами осуществляет центральный демон ammsd, c которым
 по протоколу FCGI общаются вспомогательные программы.
 Для хранения информации ammsd использует бэкенд в виде базы данных поддерживаемой
 DBI.
 
 Служебная БД состоит из следующих основных таблиц:

 lim   - лимиты
 traf  - счетчики трафика (обычный, кэшированный)
 tlog  - журнал трафика
 tval  - промежуточные значения количества трафика

    В зависимости от расширений, БД может содержать дополнительные таблицы.
 Команды не опознаваемые ammsd передаются вспомогательным программам прописанным
 в конфигурационном файле.

 Лимиты:

    Лимиты бывают трех видов: временные (T), обычные (I), родительские (P).
 Основной приоритет имеет временный лимит, потом обычный и родительский.
 Если лимит не имеет каких то параметров, он их заимствует у родительского.

 Параметры лимита: 

 Имя
 Родитель
 Объем трафика (Б,КБ,МБ,ГБ)
 Временной период (s,m,h,d) (секунда, минута, час, день)
 Состояние (статус) (0 - выключен, 1 - включен, 2 - заблокирован)
 Описание
 
    Временной период высчитывается в зависимости от типа таймера указанного в конфигурационном
 файле (abs - абсолютный таймер, rel - относительный). При rel таймере интервал высчитывается
 от времени изменения лимита, при abs - от границы временного периода.

 Профиль:

    Профиль это набор расширений, событий и прочих конфигурационных параметров с которыми 
 работает AMMS.

 Расширения (extension):

    Расширения прописываются в секции <extension> конфиг. файла. Они могут быть написаны на любом
 языке программирования. Расширения могут быть двух типов: sh - запускается как внешняя программа,
 аргументы передаются в командной строке, считывается stdout, stderr; ammsc - параметры передаются
 FCGI скрипту в URL-encoded виде, считывается HTTP ответ скрипта. Расширения обеспечивают
 необходимый дополнительный функционал (импорт лимитов, просмотр статистики, генерацию отчетов
 и т.п)

 События (event):

    Обработчик событый прописывается в секции <event>.
 События генерируются ammsd и обрабатываются расширениями. Пример: check_access.disabled_by_sys
 вызывается когда лимит пользователя отключается системой при превышении трафика.

 AMMSC КЛИЕНТ:

    AMMS клиент реализует GET запросы по протоколу HTTP, обеспечивает синтаксис управления лимитами
 и расширениями AMMSD. При необходимости клиент может поддерживать шифрование, авторизацию и т.п.
 в зависимости от типа сервера. Распределение запросов, авторизацию и прочие дополнительные
 возможности  реализует высокопроизводительный http сервер (nginx или lighttpd).

 Интеграция со SQUID:

    Для подсчета трафика используется скрипт amms-tc-squid, который осуществляет разбор access файла
 и обновление счетчиков в БД. Доступ к интернет ресурсам контролируется редиректором ammsrd который
 проверяет превышение лимита и прочие параметры аккаунта пользователя.



